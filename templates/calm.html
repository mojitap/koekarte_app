{% extends "base.html" %}
{% block title %}æ•´ãˆã‚‹ï¼ˆ60ç§’ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ï¼‰{% endblock %}
{% block content %}
<style>
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  .pills,.chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .pill,.chip{padding:6px 12px;border-radius:16px;background:#eee;cursor:pointer}
  .pill.active,.chip.active{background:#007AFF;color:#fff}
  .card{background:#fafafa;border-radius:12px;padding:16px;margin-top:14px}
  .title{font-weight:700;text-align:center;margin-bottom:8px}
  .ring{width:140px;height:140px;border-radius:50%;margin:16px auto;background:#e6f0ff;transform:scale(1);transition:transform 1s ease}
  .center{text-align:center}
  .hint{color:#666;margin-top:6px}
  .row{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
  button{padding:8px 16px;border-radius:20px;border:0;color:#fff;cursor:pointer}
  .start{background:#2ecc71}.stop{background:#e74c3c}
  .steps p{margin:6px 0}
  .steps p.active{font-weight:700}
  .footer-links{margin-top:16px;text-align:center}
  .footer-links a.button{display:inline-block;background:#ddd;padding:8px 12px;border-radius:8px;text-decoration:none}
</style>

<div class="wrap">
  <h1 class="center">æ•´ãˆã‚‹ï¼ˆ60ç§’ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ï¼‰</h1>

  <!-- ã‚«ãƒ†ã‚´ãƒª -->
  <div id="catPills" class="pills"></div>

  <div class="card">
    <div id="toolTitle" class="title"></div>

    <!-- å‘¼å¸ãƒªãƒ³ã‚° or æ‰‹é † -->
    <div id="breathArea" class="center" style="display:none">
      <div id="ring" class="ring"></div>
      <div id="actionText" class="title" style="margin-top:6px;"></div>
      <div id="hint" class="hint"></div>
    </div>
    <div id="stepsArea" class="steps" style="display:none">
      <div id="steps"></div>
      <div id="hint2" class="hint"></div>
    </div>

    <div class="row">
      <button id="startBtn" class="start">é–‹å§‹</button>
      <button id="stopBtn"  class="stop" disabled>åœæ­¢</button>
      <div id="timer">60s</div>
    </div>

    <!-- ä»–ã®æ–¹æ³• -->
    <div id="chips" class="chips" style="margin-top:12px"></div>

    <!-- ç’°å¢ƒéŸ³ï¼ˆä»»æ„ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFã€å¾Œæ—¥éŸ³ã‚’å…¥ã‚Œã‚‹æƒ³å®šï¼‰ -->
    <div class="row">
      <label><input type="checkbox" id="ambientToggle"> ç’°å¢ƒéŸ³ï¼ˆå°ã•ã‚ï¼‰</label>
      <audio id="ambientAudio" loop style="display:none"></audio>
    </div>
  </div>

  <div class="footer-links">
    <a href="/dashboard" class="button">ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STEPSETS = {
  // å‘¼å¸ç³»
  pace_66: { // ç¡çœ ï¼š6-6
    pattern:[{text:"å¸ã£ã¦ï¼ˆ6ç§’ï¼‰",sec:6},{text:"åã„ã¦ï¼ˆ6ç§’ï¼‰",sec:6}],
    note:"é¼»ã§ 6 ç§’å¸ã£ã¦ã€6 ç§’åãã¾ã™ã€‚ä¸€å®šã®ã‚†ã£ãã‚Šãƒšãƒ¼ã‚¹ã§ã€‚"
  },
  breath_336: { // ä¸å®‰ï¼š3-3-6
    pattern:[{text:"å¸ã£ã¦ï¼ˆ3ç§’ï¼‰",sec:3},{text:"æ­¢ã‚ã‚‹ï¼ˆ3ç§’ï¼‰",sec:3},{text:"åã„ã¦ï¼ˆ6ç§’ï¼‰",sec:6}],
    note:"åãæ™‚é–“ã‚’é•·ãã—ã¦è‡ªå¾‹ç¥çµŒã‚’è½ã¡ç€ã‹ã›ã¾ã™ã€‚"
  },
  breath_478: { // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼š4-7-8
    pattern:[{text:"å¸ã£ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ7ç§’ï¼‰",sec:7},{text:"åã„ã¦ï¼ˆ8ç§’ï¼‰",sec:8}],
    note:"4-7-8 ã®1ã‚µã‚¤ã‚¯ãƒ«ï¼ˆ19ç§’ï¼‰ã‚’ãã‚Šè¿”ã—ã¾ã™ã€‚"
  },
  box_4444: { // é›†ä¸­ï¼š4-4-4-4
    pattern:[{text:"å¸ã£ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ4ç§’ï¼‰",sec:4},{text:"åã„ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ4ç§’ï¼‰",sec:4}],
    note:"4-4-4-4 ã®å‡ç­‰ãƒšãƒ¼ã‚¹ã§é›†ä¸­ã‚’ä½œã‚Šã¾ã™ã€‚"
  },
  bubble_breath_34: { // è¦ªå­ï¼š3-4
    pattern:[{text:"é¼»ã§å¸ã£ã¦ï¼ˆ3ç§’ï¼‰",sec:3},{text:"ã‚·ãƒ£ãƒœãƒ³ç‰ã¿ãŸã„ã« ãµãƒ¼ï¼ˆ4ç§’ï¼‰",sec:4}],
    note:"é™ã‹ã«â€œãµãƒ¼â€ã¨å¹ãã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚å°ã•ãªãŠå­ã•ã¾ã«ã‚‚ä¼ã‚ã‚Šã‚„ã™ã„è¡¨ç¾ã§ã™ã€‚"
  },
  // ã‚¬ã‚¤ãƒ‰ç³»
  body_scan_sleep:{
    steps:[
      {text:"é ­ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"é¡”ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"è‚©ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"èƒ¸ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"è…¹ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"è¶³å…ˆã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
    ],
    note:"å„éƒ¨ä½ã‚’ã‚„ã•ã—ãã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã€‚å¿ƒåœ°ã‚ˆã•ã‚’æœ€å„ªå…ˆã§ã€‚"
  },
  thought_parking:{
    steps:[
      {text:"æµ®ã‹ã‚“ã§ããŸè€ƒãˆã‚’ã€ç®±ã€ã«å…¥ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸",sec:15},
      {text:"ç®±ã«ãƒ•ã‚¿ã‚’ã—ã¦éµã‚’ã‹ã‘ã‚‹ï¼ˆå¾Œã§é–‹ã‘ã‚Œã°OKï¼‰",sec:15},
      {text:"ã„ã¾å¿…è¦ãªæ„Ÿè¦šï¼ˆå‘¼å¸ãƒ»ä½“ï¼‰ã¸ãã£ã¨æˆ»ã‚‹",sec:15},
    ],
    note:"è€ƒãˆã‚’â€œã„ã£ãŸã‚“é ã‘ã‚‹â€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚å†é–‹ã¯ã„ã¤ã§ã‚‚ã§ãã¾ã™ã€‚"
  },
  grounding_54321:{
    steps:[
      {text:"è¦‹ãˆã‚‹ã‚‚ã®ã‚’ 5 ã¤è¦‹ã¤ã‘ã‚‹",sec:15},
      {text:"è§¦ã‚Œã‚‰ã‚Œã‚‹ã‚‚ã®ã‚’ 4 ã¤ç¢ºã‹ã‚ã‚‹",sec:15},
      {text:"èã“ãˆã‚‹éŸ³ã‚’ 3 ã¤æ¢ã™",sec:15},
      {text:"å—…ã’ã‚‹é¦™ã‚Šã‚’ 2 ã¤æ¢ã™",sec:15},
      {text:"å‘³ã‚ãˆã‚‹ã‚‚ã®ã‚’ 1 ã¤æ€ã„å‡ºã™/è©¦ã™",sec:15},
    ],
    note:"ä»Šã“ã“ã«æ„è­˜ã‚’æˆ»ã™ãŸã‚ã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€‚"
  },
  label_allow:{
    steps:[
      {text:"ã„ã¾ã®æ°—æŒã¡ã«åå‰ã‚’ã¤ã‘ã‚‹ï¼ˆä¾‹ï¼šä¸å®‰ã€ç·Šå¼µï¼‰",sec:15},
      {text:"ã€ã„ã¾ã¯ãã†æ„Ÿã˜ã¦ã„ã‚‹ã€ã¨ã‚„ã•ã—ãè¨±ã™",sec:15},
      {text:"ä½“ã®ã©ã“ã«ã‚ã‚‹ã‹ã«æ³¨æ„ã‚’å‘ã‘ã€ãµã‚ã£ã¨åºƒã’ã¦è–„ã‚ã‚‹",sec:15},
    ],
    note:"æ„Ÿæƒ…ã‚’æ‰±ã†ç¬¬ä¸€æ­©ã€‚è¦³å¯Ÿã¨è¨±å®¹ã‚’ã€‚"
  },
  pmr_micro:{
    steps:[
      {text:"è‚©ï¼šãã‚…ã£ã¨ 5 ç§’ â†’ ãµã‚ã£ã¨ 10 ç§’",sec:15},
      {text:"æ‰‹ï¼šã‚°ãƒ¼ 5 ç§’ â†’ æŒ‡ã‚’ã»ã©ã 10 ç§’",sec:15},
      {text:"é¡”ï¼šãã‚…ã£ã¨ 5 ç§’ â†’ ã‚†ã‚‹ã‚ã¦ 10 ç§’",sec:15},
    ],
    note:"ç—›ã¿ãŒã‚ã‚‹å‹•ãã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚è„±åŠ›ã®å¿ƒåœ°ã‚ˆã•ã‚’å‘³ã‚ã„ã¾ã™ã€‚"
  },
  cool_moves:{
    steps:[
      {text:"è‚©ã‚’å¾Œã‚ã«ã‚†ã£ãã‚Šå›ã™ Ã—3",sec:15},
      {text:"é¦–ã‚’å·¦å³ã«ã‚†ã£ãã‚Šå€’ã™ å„1å›",sec:20},
      {text:"é•·ã„åãæ¯ã§å…¨èº«ã‚’ã‚†ã‚‹ã‚ã‚‹",sec:15},
    ],
    note:"å‘¼å¸ã¯è‡ªç„¶ã«ã€‚ã‚ã¾ã„ãƒ»ç—›ã¿ãŒã‚ã‚Œã°ä¸­æ­¢ã€‚"
  },
  single_point_focus:{
    steps:[
      {text:"ä¸€ç‚¹ã‚’é™ã‹ã«è¦‹ã¤ã‚ã‚‹ï¼ˆãƒ¢ãƒ‹ã‚¿ã®è§’ãªã©ï¼‰",sec:20},
      {text:"ç›®ã‚’é–‰ã˜ã¦å‘¼å¸ã«æ³¨æ„ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"ã‚‚ã†ä¸€åº¦ ä¸€ç‚¹ã«é›†ä¸­",sec:20},
    ],
    note:"è¦–è¦šâ†’å†…å´â†’è¦–è¦šã®é †ã§é›†ä¸­ã‚¹ã‚¤ãƒƒãƒã‚’å…¥ã‚Œã¾ã™ã€‚"
  },
  tiny_plan:{
    steps:[
      {text:"ã“ã®1ã€œ2åˆ†ã§ã‚„ã‚‹ã€ã²ã¨ã¤ã€ã‚’æ±ºã‚ã‚‹",sec:20},
      {text:"æœ€åˆã®ä¸€æ‰‹ã‚’é ­ã®ä¸­ã§ãƒªãƒãƒ¼ã‚µãƒ«",sec:20},
      {text:"é–‹å§‹ã‚«ã‚¦ãƒ³ãƒˆï¼š3ãƒ»2ãƒ»1ï¼ˆé™ã‹ã«GOï¼‰",sec:20},
    ],
    note:"å…ˆå»¶ã°ã—å¯¾ç­–ã€‚å§‹ã‚ã‚‹ãã£ã‹ã‘ã‚’ä½œã‚Šã¾ã™ã€‚"
  },
  smile_posture:{
    steps:[
      {text:"å£è§’ã‚’å°‘ã—ä¸Šã’ã€èƒŒã™ã˜ã‚’ä¼¸ã°ã™",sec:20},
      {text:"è‚©ã‚’å¾Œã‚ã«å›ã—ã¦èƒ¸ã‚’é–‹ã",sec:10},
      {text:"æ·±å‘¼å¸ã§ã€ã™ã“ã—è»½ãã€ã‚’å‘³ã‚ã†",sec:10},
    ],
    note:"è¡¨æƒ…ã¨å§¿å‹¢ã¯æ°—åˆ†ã«ç›´çµã€‚ç„¡ç†ã®ãªã„ç¯„å›²ã§ã€‚"
  },
  gratitude_3:{
    steps:[
      {text:"å°ã•ãªæ„Ÿè¬â‘ ã‚’æ€ã„å‡ºã™",sec:20},
      {text:"å°ã•ãªæ„Ÿè¬â‘¡ã‚’æ€ã„å‡ºã™",sec:20},
      {text:"å°ã•ãªæ„Ÿè¬â‘¢ã‚’æ€ã„å‡ºã™",sec:20},
    ],
    note:"â€œå°ã•ã•â€ãŒã‚³ãƒ„ã€‚æ•°ã‚’é‡ã­ã¾ã™ã€‚"
  },
  energizer_shake:{
    steps:[
      {text:"æ‰‹ã‚’ã¶ã‚‰ã¶ã‚‰ 10 ç§’",sec:10},
      {text:"è„šã‚’ã¶ã‚‰ã¶ã‚‰ 10 ç§’",sec:10},
      {text:"èƒŒä¼¸ã³ï¼†å¤§ããæ¯ã‚’åã",sec:10},
    ],
    note:"çŸ­æ™‚é–“ã§è¡€æµã¨è¦šé†’æ„Ÿã‚’ã‚¢ãƒƒãƒ—ã€‚"
  },
  color_hunt:{
    steps:[
      {text:"é’ã„ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
      {text:"èµ¤ã„ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
      {text:"ç·‘ã®ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
    ],
    note:"éŠã³ãªãŒã‚‰â€œä»Šã“ã“â€ã«æ³¨æ„ã‚’å‘ã‘ã¾ã™ã€‚"
  },
  thank_you_game:{
    steps:[
      {text:"ã€ã‚ã‚ŠãŒã¨ã†ã€ã‚’ 1 ã¤ä¼ãˆã‚‹ï¼ˆç›¸æ‰‹/è‡ªåˆ†/ç‰©ï¼‰",sec:15},
      {text:"ã‚‚ã† 1 ã¤ã€ã‚ã‚ŠãŒã¨ã†ã€",sec:15},
      {text:"æœ€å¾Œã« ã‚‚ã† 1 ã¤ã€ã‚ã‚ŠãŒã¨ã†ã€",sec:15},
    ],
    note:"çŸ­ã„è¨€è‘‰ã§OKã€‚å¿ƒã®ä¸­ã§ã‚‚ã€‚"
  },
};

const CATEGORIES = [
  { key:'sleep', label:'ç¡çœ ', tools:[
    { key:'pace66',  label:'å‘¼å¸ï¼ˆ6-6ï¼‰',            ref:'pace_66' },
    { key:'scan',    label:'ä½“ã‚¹ã‚­ãƒ£ãƒ³',              ref:'body_scan_sleep' },
    { key:'parking', label:'æ€è€ƒãƒ‘ãƒ¼ã‚­ãƒ³ã‚°',          ref:'thought_parking' },
  ]},
  { key:'anxiety', label:'ä¸å®‰', tools:[
    { key:'54321',   label:'5-4-3-2-1',               ref:'grounding_54321' },
    { key:'b336',    label:'å‘¼å¸ï¼ˆ3-3-6ï¼‰',           ref:'breath_336' },
    { key:'allow',   label:'ãƒ©ãƒ™ãƒ«ï¼†è¨±å®¹',            ref:'label_allow' },
  ]},
  { key:'cooldown', label:'ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³', tools:[
    { key:'pmr',     label:'ãƒã‚¤ã‚¯ãƒ­è„±åŠ›ï¼ˆPMRï¼‰',     ref:'pmr_micro' },
    { key:'b478',    label:'4â€“7â€“8 å‘¼å¸',              ref:'breath_478' },
    { key:'moves',   label:'ã‚„ã•ã—ã„å‹•ã',            ref:'cool_moves' },
  ]},
  { key:'focus', label:'é›†ä¸­', tools:[
    { key:'box',     label:'ãƒœãƒƒã‚¯ã‚¹å‘¼å¸ï¼ˆ4-4-4-4ï¼‰', ref:'box_4444' },
    { key:'sp',      label:'ä¸€ç‚¹é›†ä¸­ãƒªã‚»ãƒƒãƒˆ',        ref:'single_point_focus' },
    { key:'plan',    label:'2åˆ†ãƒŸãƒ‹ãƒ—ãƒ©ãƒ³',           ref:'tiny_plan' },
  ]},
  { key:'boost', label:'æ°—åˆ†UP', tools:[
    { key:'smile',   label:'ã‚¹ãƒã‚¤ãƒ«ï¼†å§¿å‹¢',          ref:'smile_posture' },
    { key:'thanks',  label:'æ„Ÿè¬ã‚’3ã¤',               ref:'gratitude_3' },
    { key:'ener',    label:'ã‚¨ãƒŠã‚¸ãƒ£ã‚¤ã‚¶ãƒ¼',          ref:'energizer_shake' },
  ]},
  { key:'parent', label:'è¦ªå­', tools:[
    { key:'bubble',  label:'ãƒãƒ–ãƒ«å‘¼å¸ï¼ˆ3-4ï¼‰',       ref:'bubble_breath_34' },
    { key:'color',   label:'ã‚«ãƒ©ãƒ¼æ¢ã—',              ref:'color_hunt' },
    { key:'tyg',     label:'ã‚ã‚ŠãŒã¨ã†ã‚²ãƒ¼ãƒ ',         ref:'thank_you_game' },
  ]},
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‚ç…§å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pills = document.getElementById('catPills');
const chips = document.getElementById('chips');
const titleEl = document.getElementById('toolTitle');
const ring = document.getElementById('ring');
const actionEl = document.getElementById('actionText');
const hint = document.getElementById('hint');
const hint2 = document.getElementById('hint2');
const breathArea = document.getElementById('breathArea');
const stepsArea  = document.getElementById('stepsArea');
const stepsDiv = document.getElementById('steps');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const timerEl  = document.getElementById('timer');
const ambTgl = document.getElementById('ambientToggle');
const ambAud = document.getElementById('ambientAudio');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curCat = CATEGORIES[0].key;
let curToolRef = CATEGORIES[0].tools[0].ref;

let timerInt = null;
let progInt  = null;   // ã‚¹ãƒ†ãƒƒãƒ—/å‘¼å¸ã®é€²è¡Œ
let secLeft  = 60;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCats(){
  pills.innerHTML = '';
  for(const c of CATEGORIES){
    const el = document.createElement('div');
    el.className = 'pill' + (c.key===curCat?' active':'');
    el.textContent = c.label;
    el.onclick = ()=>{
      curCat = c.key;
      curToolRef = c.tools[0].ref;
      stop();
      render();
    };
    pills.appendChild(el);
  }
}

function renderChips(){
  chips.innerHTML = '';
  const cat = CATEGORIES.find(x=>x.key===curCat);
  for(const t of cat.tools){
    const el = document.createElement('div');
    el.className = 'chip' + (t.ref===curToolRef?' active':'');
    el.textContent = t.label;
    el.onclick = ()=>{
      curToolRef = t.ref;
      stop();
      renderBody();
    };
    chips.appendChild(el);
  }
}

function renderBody(){
  const cat = CATEGORIES.find(x=>x.key===curCat);
  const tool = cat.tools.find(x=>x.ref===curToolRef);
  const set = STEPSETS[curToolRef];

  titleEl.textContent = tool.label;

  const isBreath = !!set.pattern;
  breathArea.style.display = isBreath ? 'block' : 'none';
  stepsArea.style.display  = isBreath ? 'none'  : 'block';

  if(isBreath){
    actionEl.textContent = 'æº–å‚™â€¦';
    hint.textContent = set.note || '';
  }else{
    // æ‰‹é †ãƒªã‚¹ãƒˆã¨æ³¨è¨˜
    stepsDiv.innerHTML = set.steps.map((s,i)=>`<p data-i="${i}">${s.text}ï¼ˆç´„${s.sec}ç§’ï¼‰</p>`).join('');
    hint2.textContent = set.note || '';
  }

  resetTimer();
}

function render(){
  renderCats();
  renderChips();
  renderBody();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTimer(){ secLeft=60; timerEl.textContent='60s'; }

function start(){
  if(timerInt) return;
  resetTimer();
  startBtn.disabled = true;
  stopBtn.disabled  = false;

  // 60s ã‚«ã‚¦ãƒ³ãƒˆ
  timerInt = setInterval(()=>{
    secLeft--; timerEl.textContent = secLeft+'s';
    if(secLeft<=0){ stop(); alert('å®Œäº†ï¼'); }
  },1000);

  // å‘¼å¸/æ‰‹é † é€²è¡Œ
  const set = STEPSETS[curToolRef];
  if(set.pattern){
    runPattern(set.pattern);
  }else{
    runSteps(set.steps);
  }

  // ç’°å¢ƒéŸ³
  if(ambTgl.checked && ambAud.src){
    ambAud.volume = 0.15;
    ambAud.play().catch(()=>{});
  }
}

function stop(){
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  if(progInt){ clearInterval(progInt); progInt=null; }
  startBtn.disabled=false; stopBtn.disabled=true;
  ring.style.transform='scale(1)';
  if(!document.hidden){ try{ ambAud.pause(); }catch{} }
  resetTimer();
  // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
  actionEl.textContent = '';
  const ps = stepsDiv.querySelectorAll('p'); ps.forEach(p=>p.classList.remove('active'));
}

function runPattern(pattern){
  let i = 0, left = pattern[0].sec;
  actionEl.textContent = pattern[0].text;
  updateRingFor(pattern[0].text);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i = (i+1) % pattern.length;
      left = pattern[i].sec;
      actionEl.textContent = pattern[i].text;
      updateRingFor(pattern[i].text);
    }
  },1000);
}

function updateRingFor(text){
  // å¸ã†=å¤§ããã€åã=å°ã•ãã€æ­¢=çœŸã‚“ä¸­ãã‚‰ã„
  if(text.includes('å¸'))  ring.style.transform='scale(1.18)';
  else if(text.includes('å')) ring.style.transform='scale(0.92)';
  else                       ring.style.transform='scale(1.05)';
}

function runSteps(steps){
  let i = 0, left = steps[0].sec;
  markStep(i);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i++;
      if(i>=steps.length){ i=0; } // ãƒ«ãƒ¼ãƒ—
      left = steps[i].sec;
      markStep(i);
    }
  },1000);
}

function markStep(i){
  const ps = stepsDiv.querySelectorAll('p');
  ps.forEach(p=>p.classList.remove('active'));
  const cur = stepsDiv.querySelector(`p[data-i="${i}"]`);
  if(cur) cur.classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startBtn.onclick = start;
stopBtn.onclick  = stop;
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); });

// ä»»æ„ï¼šç’°å¢ƒéŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ãŸã‚‰ã“ã“ã§æŒ‡å®š
// ambAud.src = "/static/audio/rain.mp3";

// åˆæœŸæç”»
render();
</script>
{% endblock %}
