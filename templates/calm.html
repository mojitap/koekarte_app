{% extends "base.html" %}
{% block title %}æ•´ãˆã‚‹ï¼ˆ60ç§’ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ï¼‰{% endblock %}
{% block content %}
{% set SHOW_AMBIENT = false %}
<style>
  /* å…ˆé ­ã® <style> ã®ä¸€ç•ªä¸Šã«è¿½åŠ  */
  *, *::before, *::after { box-sizing: border-box; }
  
  .chips { justify-items: center; }
  .pills{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:center;
    margin-top:12px;
  }

  .pill{
    background:#fff;
    border:1px solid #ddd;
    border-radius:16px;
    padding:6px 12px;
    text-align:center;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }

  .pill.active{
    border-color:#007AFF;
    background:#eaf3ff;
    color:#003a8c;
  }
  .pills, .chips{
    justify-content: center;
  }
  .wrap{
    max-width: 720px;
    width: 100%;
    margin: 0 auto;
    padding-left:  max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }
  .chips{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap:12px;
    margin-top:12px;
  }
  .chip{
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    padding:10px 12px;
    text-align:center;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }
  .chip.active{
    border-color:#007AFF;
    background:#eaf3ff;
    color:#003a8c;
  }
  .card{
    max-width: 720px;
    margin: 14px auto;         /* ä¸­å¤®å¯„ã› */
    width: 100%;
  }
  .title{font-weight:700;text-align:center;margin-bottom:8px}
  .ring{
    width:140px; height:140px; border-radius:50%;
    margin:16px auto; background:#e6f0ff;
    transform:scale(1);
    transition: transform .8s ease-in-out; /* â† ã“ã‚Œã‚’è¿½åŠ  */
  }
  .panel{
    border:1px solid #e5e7eb;
    background:#fafafa;
    border-radius:12px;
    padding:14px;
    margin-bottom:12px;
  }
  .panel .title{ margin-top:0; }

  .control-row{                 /* é–‹å§‹/åœæ­¢ãƒœã‚¿ãƒ³è¡Œã ã‘ã«ä»˜ã‘ã‚‹ */
    border-top: 0;
    padding-top: 0;
    margin-top: 8px;
  }
  .center{text-align:center}
  .hint{color:#666;margin-top:6px}
  .row button{
    min-width:112px;
    height:48px;                /* ã‚¿ãƒƒãƒæœ€é© */
    font-size:18px;
    padding:10px 18px;
    border-radius:24px;
    border:0;
    color:#fff;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
  }
  #timer{
    min-width:72px;
    height:48px;                 /* ãƒœã‚¿ãƒ³ã¨åŒã˜é«˜ã• */
    display:flex; align-items:center; justify-content:center;
    padding:0 12px;
    font-size:18px; font-weight:700;
    border:1px solid #e5e7eb;
    border-radius:24px;
    background:#fff;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
    font-variant-numeric: tabular-nums; /* æ•°å­—ã®æ¡ãŒãƒ–ãƒ¬ãªã„å°æŠ€ï¼ˆä»»æ„ï¼‰ */
  }
  @media (pointer:coarse){
    .row button{ height:54px; font-size:20px; }
  }
  .start{background:#2ecc71}.stop{background:#e74c3c}
  .steps p{margin:6px 0}
  .steps p.active{font-weight:700}
  .footer-links{margin-top:16px;text-align:center}
  .footer-links a.button{display:inline-block;background:#ddd;padding:8px 12px;border-radius:8px;text-decoration:none}
  .row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-top:10px;
  }
  .subhead{
    margin:14px 8px 6px;
    font-size:14px;
    color:#555;
    text-align:center;
    font-weight:700;
  }
</style>

<div class="wrap">
  <h1 class="center">æ•´ãˆã‚‹ï¼ˆ60ç§’ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ï¼‰</h1>

  <!-- ã‚«ãƒ†ã‚´ãƒª -->
  <div id="catPills" class="pills"></div>

  <div class="card">
    <!-- â–¼ ã“ã“ã‚’ panel ã§å›²ã‚€ -->
    <div class="panel">
      <div id="toolTitle" class="title"></div>

      <div id="breathArea" class="center" style="display:none">
        <div id="ring" class="ring"></div>
        <div id="actionText" class="title" style="margin-top:6px;" aria-live="polite"></div>
        <div id="hint" class="hint"></div>
      </div>

      <div id="stepsArea" class="steps" style="display:none">
        <div id="steps"></div>
        <div id="hint2" class="hint"></div>
      </div>
    </div>
    <!-- â–² ã“ã“ã¾ã§ panel -->

    <!-- é–‹å§‹/åœæ­¢ã®è¡Œã«ã ã‘ control-row ã‚’è¿½åŠ  -->
    <div class="row control-row">
      <button id="startBtn" class="start">é–‹å§‹</button>
      <div id="timer" role="timer" aria-live="polite">60s</div>
      <button id="stopBtn" class="stop" disabled>åœæ­¢</button>
    </div>

    <!-- ä»–ã®æ–¹æ³• -->
    <div id="chips" class="chips" style="margin-top:12px"></div>

    <!-- ç’°å¢ƒéŸ³ ... -->
    {% if SHOW_AMBIENT %}
    <div class="row">
      <label><input type="checkbox" id="ambientToggle"> ç’°å¢ƒéŸ³ï¼ˆå°ã•ã‚ï¼‰</label>
      <select id="ambientSelect" style="margin-left:8px">
        <option value="/static/audio/rain.mp3">é›¨</option>
        <option value="/static/audio/forest.mp3">æ£®</option>
        <option value="/static/audio/cafe.mp3">ã‚«ãƒ•ã‚§</option>
      </select>
      <audio id="ambientAudio" loop style="display:none"></audio>
    </div>
    {% endif %}
  </div>

  <div class="footer-links">
    <a href="/dashboard" class="button">ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>
</div>

<script>

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STEPSETS = {
  // å‘¼å¸ç³»
  pace_66: { // ç¡çœ ï¼š6-6
    pattern:[{text:"å¸ã£ã¦ï¼ˆ6ç§’ï¼‰",sec:6},{text:"åã„ã¦ï¼ˆ6ç§’ï¼‰",sec:6}],
    note:"å¯ã‚‹å‰ã‚„é ­ã‚’ä¼‘ã‚ãŸã„æ™‚ã«ã€‚ã‚†ã£ãã‚Šä¸€å®šã®ãƒšãƒ¼ã‚¹ã§è‡ªå¾‹ç¥çµŒã‚’æ•´ãˆã¾ã™ã€‚"
  },
  breath_336: { // ä¸å®‰ï¼š3-3-6
    pattern:[{text:"å¸ã£ã¦ï¼ˆ3ç§’ï¼‰",sec:3},{text:"æ­¢ã‚ã‚‹ï¼ˆ3ç§’ï¼‰",sec:3},{text:"åã„ã¦ï¼ˆ6ç§’ï¼‰",sec:6}],
    note:"ä¸å®‰ã‚„ç·Šå¼µãŒå¼·ã„æ™‚ã«ã€‚åãæ™‚é–“ã‚’é•·ãã—ã¦è½ã¡ç€ãã‚’å–ã‚Šæˆ»ã—ã¾ã™ã€‚"
  },
  breath_478: { // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼š4-7-8
    pattern:[{text:"å¸ã£ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ7ç§’ï¼‰",sec:7},{text:"åã„ã¦ï¼ˆ8ç§’ï¼‰",sec:8}],
    note:"ã‚¤ãƒ©ã‚¤ãƒ©/é«˜ã¶ã‚Šã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚„å°±å¯å‰ã«ã€‚å¿ƒæ‹ã‚’ã‚†ã£ãã‚Šã«ã—ã¾ã™ã€‚"
  },
  box_4444: { // é›†ä¸­ï¼š4-4-4-4
    pattern:[{text:"å¸ã£ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ4ç§’ï¼‰",sec:4},{text:"åã„ã¦ï¼ˆ4ç§’ï¼‰",sec:4},{text:"æ­¢ã‚ã‚‹ï¼ˆ4ç§’ï¼‰",sec:4}],
    note:"ä½œæ¥­ã‚„ä¼šè­°å‰ã®â€œé›†ä¸­ã‚¹ã‚¤ãƒƒãƒâ€ã«ã€‚å‡ç­‰ãƒšãƒ¼ã‚¹ã§é ­ã®ãƒã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã¾ã™ã€‚"
  },
  bubble_breath_34: { // è¦ªå­ï¼š3-4
    pattern:[{text:"é¼»ã§å¸ã£ã¦ï¼ˆ3ç§’ï¼‰",sec:3},{text:"ã‚·ãƒ£ãƒœãƒ³ç‰ã¿ãŸã„ã« ãµãƒ¼ï¼ˆ4ç§’ï¼‰",sec:4}],
    note:"è¦ªå­ã®æ°—åˆ†è»¢æ›ã‚„ãªã ã‚ã«ã€‚é™ã‹ã«â€œãµãƒ¼â€ã¨å¹ãéŠã³æ„Ÿè¦šã§è½ã¡ç€ãã‚’ä¿ƒã—ã¾ã™ã€‚"
  },

  // ã‚¬ã‚¤ãƒ‰ç³»
  body_scan_sleep:{
    steps:[
      {text:"é ­ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"é¡”ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"è‚©ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"èƒ¸ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"è…¹ã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},{text:"è¶³å…ˆã«æ„è­˜ã‚’å‘ã‘ã‚‹",sec:10},
    ],
    note:"å°±å¯å‰ã‚„ç·Šå¼µã‚’ã»ã©ããŸã„æ™‚ã«ã€‚ä½“ã®éƒ¨ä½ã‚’é †ç•ªã«â€œã‚„ã•ã—ãã‚¹ã‚­ãƒ£ãƒ³â€ã—ã¾ã™ã€‚"
  },
  thought_parking:{
    steps:[
      {text:"æµ®ã‹ã‚“ã è€ƒãˆã‚’ã€ç®±ã€ã«å…¥ã‚Œã‚‹",sec:15},
      {text:"ç®±ã«ãƒ•ã‚¿ã‚’ã—ã¦éµã‚’ã‹ã‘ã‚‹",sec:15},
      {text:"å‘¼å¸ã‚„ä½“ã®æ„Ÿè¦šã¸ãã£ã¨æˆ»ã‚‹",sec:15},
    ],
    note:"è€ƒãˆãŒãã‚‹ãã‚‹ã™ã‚‹æ™‚ã®ä¸€æ™‚åœæ­¢æ³•ã€‚â€œã‚ã¨ã§å†é–‹ã§ãã‚‹â€å‰æã§æ‰‹æ”¾ã—ã¾ã™ã€‚"
  },
  grounding_54321:{
    steps:[
      {text:"è¦‹ãˆã‚‹ã‚‚ã®ã‚’ 5 ã¤è¦‹ã¤ã‘ã‚‹",sec:15},
      {text:"è§¦ã‚Œã‚‰ã‚Œã‚‹ã‚‚ã®ã‚’ 4 ã¤ç¢ºã‹ã‚ã‚‹",sec:15},
      {text:"èã“ãˆã‚‹éŸ³ã‚’ 3 ã¤æ¢ã™",sec:15},
      {text:"é¦™ã‚Šã‚’ 2 ã¤æ¢ã™",sec:15},
      {text:"å‘³ã‚’ 1 ã¤æ€ã„å‡ºã™/è©¦ã™",sec:15},
    ],
    note:"ä¸å®‰ãƒ»ã‚½ãƒ¯ã‚½ãƒ¯ãƒ»ãƒ‘ãƒ‹ãƒƒã‚¯æ°—å‘³ã«ã€‚â€œä»Šã“ã“â€ã¸æ„è­˜ã‚’æˆ»ã—ã¾ã™ã€‚"
  },
  label_allow:{
    steps:[
      {text:"ã„ã¾ã®æ°—æŒã¡ã«åå‰ã‚’ã¤ã‘ã‚‹ï¼ˆä¾‹ï¼šä¸å®‰ï¼‰",sec:15},
      {text:"ã€ã„ã¾ã¯ãã†æ„Ÿã˜ã¦ã„ã‚‹ã€ã¨è¨±ã™",sec:15},
      {text:"ä½“ã®ã©ã“ã«ã‚ã‚‹ã‹ã‚’æ„Ÿã˜ ãµã‚ã£ã¨åºƒã’ã¦è–„ã‚ã‚‹",sec:15},
    ],
    note:"æ„Ÿæƒ…ã®æ³¢ã‚’æ‰±ã†ç¬¬ä¸€æ­©ã€‚è©•ä¾¡ã›ãšè¦³å¯Ÿâ†’è¨±å®¹ã§å¼·åº¦ã‚’ä¸‹ã’ã¾ã™ã€‚"
  },
  pmr_micro:{
    steps:[
      {text:"è‚©ï¼šãã‚…ã£ã¨ 5 ç§’ â†’ ãµã‚ã£ã¨ 10 ç§’",sec:15},
      {text:"æ‰‹ï¼šã‚°ãƒ¼ 5 ç§’ â†’ æŒ‡ã‚’ã»ã©ã 10 ç§’",sec:15},
      {text:"é¡”ï¼šãã‚…ã£ã¨ 5 ç§’ â†’ ã‚†ã‚‹ã‚ã¦ 10 ç§’",sec:15},
    ],
    note:"ã“ã‚ã°ã‚Šã‚„è‚©ã“ã‚Šã«ã€‚ã€ç·Šå¼µâ†’è„±åŠ›ã€ã®å·®ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚’å­¦ç¿’ã—ã¾ã™ã€‚ï¼ˆç—›ã¿ã¯ä¸­æ­¢ï¼‰"
  },
  cool_moves:{
    steps:[
      {text:"è‚©ã‚’å¾Œã‚ã«ã‚†ã£ãã‚Šå›ã™ Ã—3",sec:15},
      {text:"é¦–ã‚’å·¦å³ã«ã‚†ã£ãã‚Šå€’ã™ å„1å›",sec:20},
      {text:"é•·ã„åãæ¯ã§å…¨èº«ã‚’ã‚†ã‚‹ã‚ã‚‹",sec:15},
    ],
    note:"çŸ­æ™‚é–“ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚„ç›®è¦šã¾ã—ã«ã€‚ã‚ã¾ã„/ç—›ã¿ãŒã‚ã‚Œã°ç„¡ç†ã›ãšä¸­æ­¢ã€‚"
  },
  single_point_focus:{
    steps:[
      {text:"ä¸€ç‚¹ã‚’é™ã‹ã«è¦‹ã¤ã‚ã‚‹",sec:20},
      {text:"ç›®ã‚’é–‰ã˜ã¦å‘¼å¸ã«æ³¨æ„ã‚’å‘ã‘ã‚‹",sec:10},
      {text:"ã‚‚ã†ä¸€åº¦ ä¸€ç‚¹ã«é›†ä¸­",sec:20},
    ],
    note:"æ°—ãŒæ•£ã‚‹æ™‚ã®å†é›†ä¸­ãƒªã‚»ãƒƒãƒˆã€‚è¦–è¦šâ†’å†…å´â†’è¦–è¦šã§åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚"
  },
  tiny_plan:{
    steps:[
      {text:"ã“ã®1ã€œ2åˆ†ã§ã‚„ã‚‹ã€ã²ã¨ã¤ã€ã‚’æ±ºã‚ã‚‹",sec:20},
      {text:"æœ€åˆã®ä¸€æ‰‹ã‚’é ­ã®ä¸­ã§ãƒªãƒãƒ¼ã‚µãƒ«",sec:20},
      {text:"é–‹å§‹ã‚«ã‚¦ãƒ³ãƒˆï¼š3ãƒ»2ãƒ»1ï¼ˆé™ã‹ã«GOï¼‰",sec:20},
    ],
    note:"å…ˆå»¶ã°ã—å¯¾ç­–ã€‚å°ã•ãå§‹ã‚ã‚‹ãã£ã‹ã‘ã‚’ä½œã‚Šã¾ã™ã€‚"
  },
  smile_posture:{
    steps:[
      {text:"å£è§’ã‚’å°‘ã—ä¸Šã’ã€èƒŒã™ã˜ã‚’ä¼¸ã°ã™",sec:20},
      {text:"è‚©ã‚’å¾Œã‚ã«å›ã—ã¦èƒ¸ã‚’é–‹ã",sec:10},
      {text:"æ·±å‘¼å¸ã§ã€ã™ã“ã—è»½ãã€ã‚’å‘³ã‚ã†",sec:10},
    ],
    note:"æ°—åˆ†ã‚’å°‘ã—ä¸Šå‘ãã«ã€‚è¡¨æƒ…ã¨å§¿å‹¢ã¯æ°—åˆ†ã«ç›´çµã—ã¾ã™ã€‚"
  },
  gratitude_3:{
    steps:[
      {text:"å°ã•ãªæ„Ÿè¬â‘ ã‚’æ€ã„å‡ºã™",sec:20},
      {text:"å°ã•ãªæ„Ÿè¬â‘¡ã‚’æ€ã„å‡ºã™",sec:20},
      {text:"å°ã•ãªæ„Ÿè¬â‘¢ã‚’æ€ã„å‡ºã™",sec:20},
    ],
    note:"è½ã¡è¾¼ã¿æ°—å‘³ã®ã¨ãã«ã€‚â€œå°ã•ãªè‰¯ã„ã“ã¨â€ã‚’3ã¤é›†ã‚ã¾ã™ã€‚"
  },
  energizer_shake:{
    steps:[
      {text:"æ‰‹ã‚’ã¶ã‚‰ã¶ã‚‰ 10 ç§’",sec:10},
      {text:"è„šã‚’ã¶ã‚‰ã¶ã‚‰ 10 ç§’",sec:10},
      {text:"èƒŒä¼¸ã³ï¼†å¤§ããåã",sec:10},
    ],
    note:"çœ æ°—ãƒ»ã ã‚‹ã•ã®å³å¸­ãƒ–ãƒ¼ã‚¹ãƒˆã€‚è¡€æµã¨è¦šé†’æ„Ÿã‚’ä¸Šã’ã¾ã™ã€‚"
  },
  color_hunt:{
    steps:[
      {text:"é’ã„ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
      {text:"èµ¤ã„ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
      {text:"ç·‘ã®ã‚‚ã®ã‚’ 3 ã¤æ¢ãã†",sec:20},
    ],
    note:"è¦ªå­ã®æ°—åˆ†è»¢æ›ã«ã€‚éŠã³ãªãŒã‚‰äº”æ„Ÿã‚’â€œä»Šã“ã“â€ã¸ã€‚"
  },
  thank_you_game:{
    steps:[
      {text:"ã€ã‚ã‚ŠãŒã¨ã†ã€ã‚’ 1 ã¤ä¼ãˆã‚‹ï¼ˆç›¸æ‰‹/è‡ªåˆ†/ç‰©ï¼‰",sec:15},
      {text:"ã‚‚ã† 1 ã¤ã€ã‚ã‚ŠãŒã¨ã†ã€",sec:15},
      {text:"æœ€å¾Œã« ã‚‚ã† 1 ã¤ã€ã‚ã‚ŠãŒã¨ã†ã€",sec:15},
    ],
    note:"è¦ªå­ãƒ»å¤«å©¦ãƒ»ãƒãƒ¼ãƒ ã§é›°å›²æ°—UPã€‚çŸ­ã„è¨€è‘‰ã§OKã€å¿ƒã®ä¸­ã§ã‚‚å¯ã€‚"
  },
};

const CATEGORIES = [
  { key:'sleep', label:'ç¡çœ ', tools:[
    { key:'pace66',  label:'å‘¼å¸ï¼ˆ6-6ï¼‰',            ref:'pace_66' },
    { key:'scan',    label:'ä½“ã‚¹ã‚­ãƒ£ãƒ³',              ref:'body_scan_sleep' },
    { key:'parking', label:'æ€è€ƒãƒ‘ãƒ¼ã‚­ãƒ³ã‚°',          ref:'thought_parking' },
  ]},
  { key:'anxiety', label:'ä¸å®‰', tools:[
    { key:'54321',   label:'5-4-3-2-1',               ref:'grounding_54321' },
    { key:'b336',    label:'å‘¼å¸ï¼ˆ3-3-6ï¼‰',           ref:'breath_336' },
    { key:'allow',   label:'ãƒ©ãƒ™ãƒ«ï¼†è¨±å®¹',            ref:'label_allow' },
  ]},
  { key:'cooldown', label:'ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³', tools:[
    { key:'pmr',     label:'ãƒã‚¤ã‚¯ãƒ­è„±åŠ›ï¼ˆPMRï¼‰',     ref:'pmr_micro' },
    { key:'b478',    label:'4â€“7â€“8 å‘¼å¸',              ref:'breath_478' },
    { key:'moves',   label:'ã‚„ã•ã—ã„å‹•ã',            ref:'cool_moves' },
  ]},
  { key:'focus', label:'é›†ä¸­', tools:[
    { key:'box',     label:'ãƒœãƒƒã‚¯ã‚¹å‘¼å¸ï¼ˆ4-4-4-4ï¼‰', ref:'box_4444' },
    { key:'sp',      label:'ä¸€ç‚¹é›†ä¸­ãƒªã‚»ãƒƒãƒˆ',        ref:'single_point_focus' },
    { key:'plan',    label:'2åˆ†ãƒŸãƒ‹ãƒ—ãƒ©ãƒ³',           ref:'tiny_plan' },
  ]},
  { key:'boost', label:'æ°—åˆ†UP', tools:[
    { key:'smile',   label:'ã‚¹ãƒã‚¤ãƒ«ï¼†å§¿å‹¢',          ref:'smile_posture' },
    { key:'thanks',  label:'æ„Ÿè¬ã‚’3ã¤',               ref:'gratitude_3' },
    { key:'ener',    label:'ã‚¨ãƒŠã‚¸ãƒ£ã‚¤ã‚¶ãƒ¼',          ref:'energizer_shake' },
  ]},
  { key:'parent', label:'è¦ªå­', tools:[
    { key:'bubble',  label:'ãƒãƒ–ãƒ«å‘¼å¸ï¼ˆ3-4ï¼‰',       ref:'bubble_breath_34' },
    { key:'color',   label:'ã‚«ãƒ©ãƒ¼æ¢ã—',              ref:'color_hunt' },
    { key:'tyg',     label:'ã‚ã‚ŠãŒã¨ã†ã‚²ãƒ¼ãƒ ',         ref:'thank_you_game' },
  ]},
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‚ç…§å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pills = document.getElementById('catPills');
const chips = document.getElementById('chips');
const titleEl = document.getElementById('toolTitle');
const ring = document.getElementById('ring');
const actionEl = document.getElementById('actionText');
const hint = document.getElementById('hint');
const hint2 = document.getElementById('hint2');
const breathArea = document.getElementById('breathArea');
const stepsArea  = document.getElementById('stepsArea');
const stepsDiv = document.getElementById('steps');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const timerEl  = document.getElementById('timer');
const ambTgl = document.getElementById('ambientToggle') || null;
const ambAud = document.getElementById('ambientAudio') || null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curCat = CATEGORIES[0].key;
let curToolRef = CATEGORIES[0].tools[0].ref;

let timerInt = null;
let progInt  = null;   // ã‚¹ãƒ†ãƒƒãƒ—/å‘¼å¸ã®é€²è¡Œ
let secLeft  = 60;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCats(){
  pills.innerHTML = '';
  for(const c of CATEGORIES){
    const el = document.createElement('div');
    el.className = 'pill' + (c.key===curCat?' active':'');
    el.textContent = c.label;
    el.onclick = ()=>{
      curCat = c.key;
      curToolRef = c.tools[0].ref;
      stop();
      render();
    };
    pills.appendChild(el);
  }
}

function renderChips(){
  chips.innerHTML = '';
  const cat = CATEGORIES.find(x => x.key === curCat);
  for (const t of cat.tools){
    const el = document.createElement('div');
    el.className = 'chip' + (t.ref === curToolRef ? ' active' : '');
    el.textContent = t.label;
    el.onclick = () => {
      curToolRef = t.ref;
      stop();
      // â† ã“ã“ã‚’è¿½åŠ ï¼šè¦‹ãŸç›®ã ã‘å³åº§ã«æ›´æ–°
      document.querySelectorAll('#chips .chip')
        .forEach(n => n.classList.remove('active'));
      el.classList.add('active');

      renderBody();      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã ã‘æ›´æ–°ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã¯åœæ­¢ä¸­ï¼‰
    };
    chips.appendChild(el);
  }
}

function renderBody(){
  const cat  = CATEGORIES.find(x=>x.key===curCat);
  const tool = cat.tools.find(x=>x.ref===curToolRef);
  const set  = STEPSETS[curToolRef];

  titleEl.textContent = tool.label;

  const isBreath = !!set.pattern;
  breathArea.style.display = isBreath ? 'block' : 'none';
  stepsArea.style.display  = isBreath ? 'none'  : 'block';

  if(isBreath){
    actionEl.textContent = 'æº–å‚™â€¦';
    // â† ãƒ©ãƒ™ãƒ«ä»˜ãã§èª¬æ˜ã‚’æ˜ç¤º
    hint.textContent = (set.note ? `èª¬æ˜ï¼š${set.note}` : '');
  }else{
    // ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆé–‹å§‹ã—ãŸã‚‰ showStep() ãŒ1è¡Œè¡¨ç¤ºã«åˆ‡æ›¿ï¼‰
    stepsDiv.innerHTML = set.steps
      .map((s,i)=>`<p data-i="${i}">${s.text}ï¼ˆç´„${s.sec}ç§’ï¼‰</p>`).join('');
    // â† ãƒ©ãƒ™ãƒ«ä»˜ãã§èª¬æ˜ã‚’æ˜ç¤ºï¼ˆå¸¸æ™‚æœ€ä¸‹éƒ¨ï¼‰
    hint2.textContent = (set.note ? `èª¬æ˜ï¼š${set.note}` : '');
  }

  resetTimer();
}

function render(){
  renderCats();
  renderChips();
  renderBody();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTimer(){ secLeft=60; timerEl.textContent='60s'; }

let tickInt=null, sec=60, stepIdx=0, stepRemain=0, seq=[];

function getSequence(){
  const def = STEPSETS[curToolRef] || null;
  if (!def) return [];
  // å‘¼å¸ãƒ‘ã‚¿ãƒ¼ãƒ³ or ã‚¹ãƒ†ãƒƒãƒ—
  return def.pattern || def.steps || [];
}

function showStep(s){
  // å‘¼å¸ãƒ„ãƒ¼ãƒ«ï¼šãƒ†ã‚­ã‚¹ãƒˆï¼†ãƒªãƒ³ã‚°æ›´æ–°
  if (STEPSETS[curToolRef]?.pattern){
    actionEl.textContent = s.text;
    ringBy(s.text);
  } else {
    // æ‰‹é †ãƒ„ãƒ¼ãƒ«ï¼šä¸€è¦§ã¯æ®‹ã—ãŸã¾ã¾ã€ç¾åœ¨è¡Œã ã‘ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    markStep(stepIdx);
  }
}

function start(){
  if (tickInt) return;

  // åˆæœŸåŒ–
  sec = 60; timerEl.textContent = '60s';
  startBtn.disabled = true; stopBtn.disabled = false;

  seq = getSequence();
  stepIdx = 0;
  stepRemain = (seq[0]?.sec || 3);
  showStep(seq[0] || {text: 'ã‚¹ã‚¿ãƒ¼ãƒˆ', sec: 3});

  // é€²è¡Œ
  tickInt = setInterval(()=>{
    // å…¨ä½“
    sec -= 1;
    timerEl.textContent = sec + 's';
    if (sec <= 0){ stop(); alert('å®Œäº†ï¼'); return; }

    // ã‚¹ãƒ†ãƒƒãƒ—
    stepRemain -= 1;
    if (stepRemain <= 0 && seq.length){
      stepIdx = (stepIdx + 1) % seq.length;
      stepRemain = seq[stepIdx].sec || 3;
      showStep(seq[stepIdx]);
    }
  }, 1000);

  // ç’°å¢ƒéŸ³ï¼ˆä»»æ„ï¼‰
  if (ambTgl && ambTgl.checked && ambAud && ambAud.src){
    ambAud.volume = 0.15;
    ambAud.currentTime = 0;
    ambAud.play().catch(()=>{});
  }
}

function stop(){
  if (tickInt){ clearInterval(tickInt); tickInt = null; }
  startBtn.disabled = false; stopBtn.disabled = true;
  ring.style.transform = 'scale(1)';
  if (ambAud){ try { ambAud.pause(); } catch(e){} }
  sec = 60; timerEl.textContent = '60s';

  // å‘¼å¸ç³»ã¯èª¬æ˜æ–‡ã‚’æˆ»ã™ã€ã‚¹ãƒ†ãƒƒãƒ—ç³»ã¯å…ƒã®å…¨æ‰‹é †ãƒªã‚¹ãƒˆã«æˆ»ã™
  const set = STEPSETS[curToolRef];
  if (set?.pattern) { hint.textContent = set.note || ''; }

  // â† è¿½åŠ ï¼šåœæ­¢æ™‚ã«ãƒ‡ãƒ•ã‚©è¡¨ç¤ºã¸ï¼ˆä¸€è¦§ã«æˆ»ã™ï¼‰
  renderBody();
}

function runPattern(pattern){
  let i = 0, left = pattern[0].sec;
  actionEl.textContent = pattern[0].text;
  updateRingFor(pattern[0].text);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i = (i+1) % pattern.length;
      left = pattern[i].sec;
      actionEl.textContent = pattern[i].text;
      updateRingFor(pattern[i].text);
    }
  },1000);
}

function updateRingFor(text){
  // å¸ã†=å¤§ããã€åã=å°ã•ãã€æ­¢=çœŸã‚“ä¸­ãã‚‰ã„
  if(text.includes('å¸'))  ring.style.transform='scale(1.18)';
  else if(text.includes('å')) ring.style.transform='scale(0.92)';
  else                       ring.style.transform='scale(1.05)';
}

function runSteps(steps){
  let i = 0, left = steps[0].sec;
  markStep(i);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i++;
      if(i>=steps.length){ i=0; } // ãƒ«ãƒ¼ãƒ—
      left = steps[i].sec;
      markStep(i);
    }
  },1000);
}

function markStep(i){
  const ps = stepsDiv.querySelectorAll('p');
  ps.forEach(p=>p.classList.remove('active'));
  const cur = stepsDiv.querySelector(`p[data-i="${i}"]`);
  if(cur) cur.classList.add('active');
}

function ringBy(text){
  if (/å¸/.test(text))      ring.style.transform = 'scale(1.18)';
  else if (/å/.test(text)) ring.style.transform = 'scale(0.90)';
  else                      ring.style.transform = 'scale(1.00)';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startBtn.onclick = start;
stopBtn.onclick  = stop;
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); });

// ä»»æ„ï¼šç’°å¢ƒéŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ãŸã‚‰ã“ã“ã§æŒ‡å®š
// ambAud.src = "/static/audio/rain.mp3";

// åˆæœŸæç”»
render();
</script>
{% endblock %}
