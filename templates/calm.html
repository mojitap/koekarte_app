{% extends "base.html" %}
{% block title %}整える（60秒ミニツール）{% endblock %}
{% block content %}
{% set SHOW_AMBIENT = false %}
<style>
  /* 先頭の <style> の一番上に追加 */
  *, *::before, *::after { box-sizing: border-box; }
  
  .chips { justify-items: center; }
  .pills{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:center;
    margin-top:12px;
  }

  .pill{
    background:#fff;
    border:1px solid #ddd;
    border-radius:16px;
    padding:6px 12px;
    text-align:center;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }

  .pill.active{
    border-color:#007AFF;
    background:#eaf3ff;
    color:#003a8c;
  }
  .pills, .chips{
    justify-content: center;
  }
  .wrap{
    max-width: 720px;
    width: 100%;
    margin: 0 auto;
    padding-left:  max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }
  .chips{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap:12px;
    margin-top:12px;
  }
  .chip{
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    padding:10px 12px;
    text-align:center;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }
  .chip.active{
    border-color:#007AFF;
    background:#eaf3ff;
    color:#003a8c;
  }
  .card{
    max-width: 720px;
    margin: 14px auto;         /* 中央寄せ */
    width: 100%;
  }
  .title{font-weight:700;text-align:center;margin-bottom:8px}
  .ring{
    width:140px; height:140px; border-radius:50%;
    margin:16px auto; background:#e6f0ff;
    transform:scale(1);
    transition: transform .8s ease-in-out; /* ← これを追加 */
  }
  .panel{
    border:1px solid #e5e7eb;
    background:#fafafa;
    border-radius:12px;
    padding:14px;
    margin-bottom:12px;
  }
  .panel .title{ margin-top:0; }

  .control-row{                 /* 開始/停止ボタン行だけに付ける */
    border-top: 0;
    padding-top: 0;
    margin-top: 8px;
  }
  .center{text-align:center}
  .hint{color:#666;margin-top:6px}
  .row button{
    min-width:112px;
    height:48px;                /* タッチ最適 */
    font-size:18px;
    padding:10px 18px;
    border-radius:24px;
    border:0;
    color:#fff;
    cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
  }
  #timer{
    min-width:72px;
    height:48px;                 /* ボタンと同じ高さ */
    display:flex; align-items:center; justify-content:center;
    padding:0 12px;
    font-size:18px; font-weight:700;
    border:1px solid #e5e7eb;
    border-radius:24px;
    background:#fff;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
    font-variant-numeric: tabular-nums; /* 数字の桁がブレない小技（任意） */
  }
  @media (pointer:coarse){
    .row button{ height:54px; font-size:20px; }
  }
  .start{background:#2ecc71}.stop{background:#e74c3c}
  .steps p{margin:6px 0}
  .steps p.active{font-weight:700}
  .footer-links{margin-top:16px;text-align:center}
  .footer-links a.button{display:inline-block;background:#ddd;padding:8px 12px;border-radius:8px;text-decoration:none}
  .row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-top:10px;
  }
  .subhead{
    margin:14px 8px 6px;
    font-size:14px;
    color:#555;
    text-align:center;
    font-weight:700;
  }
</style>

<div class="wrap">
  <h1 class="center">整える（60秒ミニツール）</h1>

  <!-- カテゴリ -->
  <div id="catPills" class="pills"></div>

  <div class="card">
    <!-- ▼ ここを panel で囲む -->
    <div class="panel">
      <div id="toolTitle" class="title"></div>

      <div id="breathArea" class="center" style="display:none">
        <div id="ring" class="ring"></div>
        <div id="actionText" class="title" style="margin-top:6px;" aria-live="polite"></div>
        <div id="hint" class="hint"></div>
      </div>

      <div id="stepsArea" class="steps" style="display:none">
        <div id="steps"></div>
        <div id="hint2" class="hint"></div>
      </div>
    </div>
    <!-- ▲ ここまで panel -->

    <!-- 開始/停止の行にだけ control-row を追加 -->
    <div class="row control-row">
      <button id="startBtn" class="start">開始</button>
      <div id="timer" role="timer" aria-live="polite">60s</div>
      <button id="stopBtn" class="stop" disabled>停止</button>
    </div>

    <!-- 他の方法 -->
    <div id="chips" class="chips" style="margin-top:12px"></div>

    <!-- 環境音 ... -->
    {% if SHOW_AMBIENT %}
    <div class="row">
      <label><input type="checkbox" id="ambientToggle"> 環境音（小さめ）</label>
      <select id="ambientSelect" style="margin-left:8px">
        <option value="/static/audio/rain.mp3">雨</option>
        <option value="/static/audio/forest.mp3">森</option>
        <option value="/static/audio/cafe.mp3">カフェ</option>
      </select>
      <audio id="ambientAudio" loop style="display:none"></audio>
    </div>
    {% endif %}
  </div>

  <div class="footer-links">
    <a href="/dashboard" class="button">🏠 マイページに戻る</a>
  </div>
</div>

<script>

// ───────────────── カリキュラム定義 ─────────────────
const STEPSETS = {
  // 呼吸系
  pace_66: { // 睡眠：6-6
    pattern:[{text:"吸って（6秒）",sec:6},{text:"吐いて（6秒）",sec:6}],
    note:"寝る前や頭を休めたい時に。ゆっくり一定のペースで自律神経を整えます。"
  },
  breath_336: { // 不安：3-3-6
    pattern:[{text:"吸って（3秒）",sec:3},{text:"止める（3秒）",sec:3},{text:"吐いて（6秒）",sec:6}],
    note:"不安や緊張が強い時に。吐く時間を長くして落ち着きを取り戻します。"
  },
  breath_478: { // クールダウン：4-7-8
    pattern:[{text:"吸って（4秒）",sec:4},{text:"止める（7秒）",sec:7},{text:"吐いて（8秒）",sec:8}],
    note:"イライラ/高ぶりのクールダウンや就寝前に。心拍をゆっくりにします。"
  },
  box_4444: { // 集中：4-4-4-4
    pattern:[{text:"吸って（4秒）",sec:4},{text:"止める（4秒）",sec:4},{text:"吐いて（4秒）",sec:4},{text:"止める（4秒）",sec:4}],
    note:"作業や会議前の“集中スイッチ”に。均等ペースで頭のノイズを減らします。"
  },
  bubble_breath_34: { // 親子：3-4
    pattern:[{text:"鼻で吸って（3秒）",sec:3},{text:"シャボン玉みたいに ふー（4秒）",sec:4}],
    note:"親子の気分転換やなだめに。静かに“ふー”と吹く遊び感覚で落ち着きを促します。"
  },

  // ガイド系
  body_scan_sleep:{
    steps:[
      {text:"頭に意識を向ける",sec:10},{text:"顔に意識を向ける",sec:10},
      {text:"肩に意識を向ける",sec:10},{text:"胸に意識を向ける",sec:10},
      {text:"腹に意識を向ける",sec:10},{text:"足先に意識を向ける",sec:10},
    ],
    note:"就寝前や緊張をほどきたい時に。体の部位を順番に“やさしくスキャン”します。"
  },
  thought_parking:{
    steps:[
      {text:"浮かんだ考えを『箱』に入れる",sec:15},
      {text:"箱にフタをして鍵をかける",sec:15},
      {text:"呼吸や体の感覚へそっと戻る",sec:15},
    ],
    note:"考えがぐるぐるする時の一時停止法。“あとで再開できる”前提で手放します。"
  },
  grounding_54321:{
    steps:[
      {text:"見えるものを 5 つ見つける",sec:15},
      {text:"触れられるものを 4 つ確かめる",sec:15},
      {text:"聞こえる音を 3 つ探す",sec:15},
      {text:"香りを 2 つ探す",sec:15},
      {text:"味を 1 つ思い出す/試す",sec:15},
    ],
    note:"不安・ソワソワ・パニック気味に。“今ここ”へ意識を戻します。"
  },
  label_allow:{
    steps:[
      {text:"いまの気持ちに名前をつける（例：不安）",sec:15},
      {text:"『いまはそう感じている』と許す",sec:15},
      {text:"体のどこにあるかを感じ ふわっと広げて薄める",sec:15},
    ],
    note:"感情の波を扱う第一歩。評価せず観察→許容で強度を下げます。"
  },
  pmr_micro:{
    steps:[
      {text:"肩：ぎゅっと 5 秒 → ふわっと 10 秒",sec:15},
      {text:"手：グー 5 秒 → 指をほどく 10 秒",sec:15},
      {text:"顔：ぎゅっと 5 秒 → ゆるめて 10 秒",sec:15},
    ],
    note:"こわばりや肩こりに。『緊張→脱力』の差でリラックスを学習します。（痛みは中止）"
  },
  cool_moves:{
    steps:[
      {text:"肩を後ろにゆっくり回す ×3",sec:15},
      {text:"首を左右にゆっくり倒す 各1回",sec:20},
      {text:"長い吐く息で全身をゆるめる",sec:15},
    ],
    note:"短時間のリフレッシュや目覚ましに。めまい/痛みがあれば無理せず中止。"
  },
  single_point_focus:{
    steps:[
      {text:"一点を静かに見つめる",sec:20},
      {text:"目を閉じて呼吸に注意を向ける",sec:10},
      {text:"もう一度 一点に集中",sec:20},
    ],
    note:"気が散る時の再集中リセット。視覚→内側→視覚で切り替えます。"
  },
  tiny_plan:{
    steps:[
      {text:"この1〜2分でやる『ひとつ』を決める",sec:20},
      {text:"最初の一手を頭の中でリハーサル",sec:20},
      {text:"開始カウント：3・2・1（静かにGO）",sec:20},
    ],
    note:"先延ばし対策。小さく始めるきっかけを作ります。"
  },
  smile_posture:{
    steps:[
      {text:"口角を少し上げ、背すじを伸ばす",sec:20},
      {text:"肩を後ろに回して胸を開く",sec:10},
      {text:"深呼吸で『すこし軽く』を味わう",sec:10},
    ],
    note:"気分を少し上向きに。表情と姿勢は気分に直結します。"
  },
  gratitude_3:{
    steps:[
      {text:"小さな感謝①を思い出す",sec:20},
      {text:"小さな感謝②を思い出す",sec:20},
      {text:"小さな感謝③を思い出す",sec:20},
    ],
    note:"落ち込み気味のときに。“小さな良いこと”を3つ集めます。"
  },
  energizer_shake:{
    steps:[
      {text:"手をぶらぶら 10 秒",sec:10},
      {text:"脚をぶらぶら 10 秒",sec:10},
      {text:"背伸び＆大きく吐く",sec:10},
    ],
    note:"眠気・だるさの即席ブースト。血流と覚醒感を上げます。"
  },
  color_hunt:{
    steps:[
      {text:"青いものを 3 つ探そう",sec:20},
      {text:"赤いものを 3 つ探そう",sec:20},
      {text:"緑のものを 3 つ探そう",sec:20},
    ],
    note:"親子の気分転換に。遊びながら五感を“今ここ”へ。"
  },
  thank_you_game:{
    steps:[
      {text:"『ありがとう』を 1 つ伝える（相手/自分/物）",sec:15},
      {text:"もう 1 つ『ありがとう』",sec:15},
      {text:"最後に もう 1 つ『ありがとう』",sec:15},
    ],
    note:"親子・夫婦・チームで雰囲気UP。短い言葉でOK、心の中でも可。"
  },
};

const CATEGORIES = [
  { key:'sleep', label:'睡眠', tools:[
    { key:'pace66',  label:'呼吸（6-6）',            ref:'pace_66' },
    { key:'scan',    label:'体スキャン',              ref:'body_scan_sleep' },
    { key:'parking', label:'思考パーキング',          ref:'thought_parking' },
  ]},
  { key:'anxiety', label:'不安', tools:[
    { key:'54321',   label:'5-4-3-2-1',               ref:'grounding_54321' },
    { key:'b336',    label:'呼吸（3-3-6）',           ref:'breath_336' },
    { key:'allow',   label:'ラベル＆許容',            ref:'label_allow' },
  ]},
  { key:'cooldown', label:'クールダウン', tools:[
    { key:'pmr',     label:'マイクロ脱力（PMR）',     ref:'pmr_micro' },
    { key:'b478',    label:'4–7–8 呼吸',              ref:'breath_478' },
    { key:'moves',   label:'やさしい動き',            ref:'cool_moves' },
  ]},
  { key:'focus', label:'集中', tools:[
    { key:'box',     label:'ボックス呼吸（4-4-4-4）', ref:'box_4444' },
    { key:'sp',      label:'一点集中リセット',        ref:'single_point_focus' },
    { key:'plan',    label:'2分ミニプラン',           ref:'tiny_plan' },
  ]},
  { key:'boost', label:'気分UP', tools:[
    { key:'smile',   label:'スマイル＆姿勢',          ref:'smile_posture' },
    { key:'thanks',  label:'感謝を3つ',               ref:'gratitude_3' },
    { key:'ener',    label:'エナジャイザー',          ref:'energizer_shake' },
  ]},
  { key:'parent', label:'親子', tools:[
    { key:'bubble',  label:'バブル呼吸（3-4）',       ref:'bubble_breath_34' },
    { key:'color',   label:'カラー探し',              ref:'color_hunt' },
    { key:'tyg',     label:'ありがとうゲーム',         ref:'thank_you_game' },
  ]},
];

// ───────────────── 参照取得 ─────────────────
const pills = document.getElementById('catPills');
const chips = document.getElementById('chips');
const titleEl = document.getElementById('toolTitle');
const ring = document.getElementById('ring');
const actionEl = document.getElementById('actionText');
const hint = document.getElementById('hint');
const hint2 = document.getElementById('hint2');
const breathArea = document.getElementById('breathArea');
const stepsArea  = document.getElementById('stepsArea');
const stepsDiv = document.getElementById('steps');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const timerEl  = document.getElementById('timer');
const ambTgl = document.getElementById('ambientToggle') || null;
const ambAud = document.getElementById('ambientAudio') || null;

// ───────────────── 状態 ─────────────────
let curCat = CATEGORIES[0].key;
let curToolRef = CATEGORIES[0].tools[0].ref;

let timerInt = null;
let progInt  = null;   // ステップ/呼吸の進行
let secLeft  = 60;

// ───────────────── 描画 ─────────────────
function renderCats(){
  pills.innerHTML = '';
  for(const c of CATEGORIES){
    const el = document.createElement('div');
    el.className = 'pill' + (c.key===curCat?' active':'');
    el.textContent = c.label;
    el.onclick = ()=>{
      curCat = c.key;
      curToolRef = c.tools[0].ref;
      stop();
      render();
    };
    pills.appendChild(el);
  }
}

function renderChips(){
  chips.innerHTML = '';
  const cat = CATEGORIES.find(x => x.key === curCat);
  for (const t of cat.tools){
    const el = document.createElement('div');
    el.className = 'chip' + (t.ref === curToolRef ? ' active' : '');
    el.textContent = t.label;
    el.onclick = () => {
      curToolRef = t.ref;
      stop();
      // ← ここを追加：見た目だけ即座に更新
      document.querySelectorAll('#chips .chip')
        .forEach(n => n.classList.remove('active'));
      el.classList.add('active');

      renderBody();      // コンテンツだけ更新（タイマーは停止中）
    };
    chips.appendChild(el);
  }
}

function renderBody(){
  const cat  = CATEGORIES.find(x=>x.key===curCat);
  const tool = cat.tools.find(x=>x.ref===curToolRef);
  const set  = STEPSETS[curToolRef];

  titleEl.textContent = tool.label;

  const isBreath = !!set.pattern;
  breathArea.style.display = isBreath ? 'block' : 'none';
  stepsArea.style.display  = isBreath ? 'none'  : 'block';

  if(isBreath){
    actionEl.textContent = '準備…';
    // ← ラベル付きで説明を明示
    hint.textContent = (set.note ? `説明：${set.note}` : '');
  }else{
    // 一覧を表示（開始したら showStep() が1行表示に切替）
    stepsDiv.innerHTML = set.steps
      .map((s,i)=>`<p data-i="${i}">${s.text}（約${s.sec}秒）</p>`).join('');
    // ← ラベル付きで説明を明示（常時最下部）
    hint2.textContent = (set.note ? `説明：${set.note}` : '');
  }

  resetTimer();
}

function render(){
  renderCats();
  renderChips();
  renderBody();
}

// ───────────────── 進行ロジック ─────────────────
function resetTimer(){ secLeft=60; timerEl.textContent='60s'; }

let tickInt=null, sec=60, stepIdx=0, stepRemain=0, seq=[];

function getSequence(){
  const def = STEPSETS[curToolRef] || null;
  if (!def) return [];
  // 呼吸パターン or ステップ
  return def.pattern || def.steps || [];
}

function showStep(s){
  // 呼吸ツール：テキスト＆リング更新
  if (STEPSETS[curToolRef]?.pattern){
    actionEl.textContent = s.text;
    ringBy(s.text);
  } else {
    // 手順ツール：一覧は残したまま、現在行だけハイライト
    markStep(stepIdx);
  }
}

function start(){
  if (tickInt) return;

  // 初期化
  sec = 60; timerEl.textContent = '60s';
  startBtn.disabled = true; stopBtn.disabled = false;

  seq = getSequence();
  stepIdx = 0;
  stepRemain = (seq[0]?.sec || 3);
  showStep(seq[0] || {text: 'スタート', sec: 3});

  // 進行
  tickInt = setInterval(()=>{
    // 全体
    sec -= 1;
    timerEl.textContent = sec + 's';
    if (sec <= 0){ stop(); alert('完了！'); return; }

    // ステップ
    stepRemain -= 1;
    if (stepRemain <= 0 && seq.length){
      stepIdx = (stepIdx + 1) % seq.length;
      stepRemain = seq[stepIdx].sec || 3;
      showStep(seq[stepIdx]);
    }
  }, 1000);

  // 環境音（任意）
  if (ambTgl && ambTgl.checked && ambAud && ambAud.src){
    ambAud.volume = 0.15;
    ambAud.currentTime = 0;
    ambAud.play().catch(()=>{});
  }
}

function stop(){
  if (tickInt){ clearInterval(tickInt); tickInt = null; }
  startBtn.disabled = false; stopBtn.disabled = true;
  ring.style.transform = 'scale(1)';
  if (ambAud){ try { ambAud.pause(); } catch(e){} }
  sec = 60; timerEl.textContent = '60s';

  // 呼吸系は説明文を戻す、ステップ系は元の全手順リストに戻す
  const set = STEPSETS[curToolRef];
  if (set?.pattern) { hint.textContent = set.note || ''; }

  // ← 追加：停止時にデフォ表示へ（一覧に戻す）
  renderBody();
}

function runPattern(pattern){
  let i = 0, left = pattern[0].sec;
  actionEl.textContent = pattern[0].text;
  updateRingFor(pattern[0].text);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i = (i+1) % pattern.length;
      left = pattern[i].sec;
      actionEl.textContent = pattern[i].text;
      updateRingFor(pattern[i].text);
    }
  },1000);
}

function updateRingFor(text){
  // 吸う=大きく、吐く=小さく、止=真ん中くらい
  if(text.includes('吸'))  ring.style.transform='scale(1.18)';
  else if(text.includes('吐')) ring.style.transform='scale(0.92)';
  else                       ring.style.transform='scale(1.05)';
}

function runSteps(steps){
  let i = 0, left = steps[0].sec;
  markStep(i);

  progInt = setInterval(()=>{
    left--;
    if(left<=0){
      i++;
      if(i>=steps.length){ i=0; } // ループ
      left = steps[i].sec;
      markStep(i);
    }
  },1000);
}

function markStep(i){
  const ps = stepsDiv.querySelectorAll('p');
  ps.forEach(p=>p.classList.remove('active'));
  const cur = stepsDiv.querySelector(`p[data-i="${i}"]`);
  if(cur) cur.classList.add('active');
}

function ringBy(text){
  if (/吸/.test(text))      ring.style.transform = 'scale(1.18)';
  else if (/吐/.test(text)) ring.style.transform = 'scale(0.90)';
  else                      ring.style.transform = 'scale(1.00)';
}

// ───────────────── イベント ─────────────────
startBtn.onclick = start;
stopBtn.onclick  = stop;
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); });

// 任意：環境音ファイルを置いたらここで指定
// ambAud.src = "/static/audio/rain.mp3";

// 初期描画
render();
</script>
{% endblock %}
