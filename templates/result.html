<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢ã®æ¨ç§»</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      text-align: center;
      max-width: 900px;
      margin: auto;
      padding: 30px;
      font-family: sans-serif;
      font-size: 16px;
    }
    a.button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #f0f0f0;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    .btn-outline-primary {
      display: inline-block;
      padding: 8px 16px;
      border: 1px solid #007bff;
      border-radius: 5px;
      color: #007bff;
      background-color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    .btn-outline-primary:hover {
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
    }
    .btn-warning {
      display: inline-block;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #ffc107;
      color: #000;
      font-weight: bold;
      text-decoration: none;
    }
  </style>
</head>
<body>
    <h1>ğŸ“ˆ ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢ã®æ¨ç§»</h1>

    <p style="text-align: center; font-size: 14px;">
        â€» ã‚¹ã‚³ã‚¢ã¯ã€Œå£°ã®å…ƒæ°—ã•ãƒ»æ´»åŠ›ã€ã‚’æ•°å€¤åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚<br>
        æ•°å€¤ãŒé«˜ã„ã»ã©ã€ã‚¹ãƒˆãƒ¬ã‚¹ãŒå°‘ãªã„ï¼ˆèª¿å­ãŒè‰¯ã„ï¼‰å‚¾å‘ã‚’ç¤ºã—ã¾ã™ã€‚<br>
        ç™»éŒ²åˆæœŸ5å›ã®å¹³å‡ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰ã¨æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€æ—¥ã€…ã®å¤‰åŒ–ãŒã‚ã‹ã‚Šã¾ã™ã€‚
    </p>

    <p>éå»ã®ã‚¹ã‚³ã‚¢æ¨ç§»ã‚’å¯è¦–åŒ–ã—ãŸã‚°ãƒ©ãƒ•ã§ã™</p>
    
    <div style="margin-bottom: 20px;">
        <a href="/result?range=all">ğŸ“Š ã™ã¹ã¦</a> |
        <a href="/result?range=past">ğŸ•° å…ˆæœˆ</a> |
        <a href="/result?range=month">ğŸ“… ä»Šæœˆ</a> |
        <a href="/result?range=week">ğŸ—“ ç›´è¿‘1é€±é–“</a>
    </div>

    <canvas id="stressChart" width="350" height="220" style="max-width: 100%; height: auto;"></canvas>

    <div id="iconRow" style="margin-top: 20px; font-size: 24px;"></div>

{% if not FREE_MODE %}
  {% if CAN_USE_PREMIUM %}
    <div style="padding: 8px; border: 1px solid #90ee90; border-radius: 6px; background: #f0fff0; margin:12px auto 8px; max-width:440px;">
      <p style="font-size: 13px; color: #060; margin:0;">
        ğŸŸ <strong>æœ‰æ–™ä¼šå“¡</strong>ã¨ã—ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ï¼
      </p>
    </div>
  {% elif current_user.has_ever_paid %}
    <div style="padding: 8px; border: 1px solid #faa; border-radius: 6px; background: #fff0f0; margin:12px auto 8px; max-width:440px;">
      <p style="font-size: 13px; color: #a00; margin:0;">
        âš ï¸ <strong>ç„¡æ–™æœŸé–“ã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚</strong><br>
        å†åº¦ã”åˆ©ç”¨ã„ãŸã ãã«ã¯æœ‰æ–™ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚
      </p>
      <a href="{{ url_for('checkout') }}" class="btn btn-warning" style="margin-top:6px;">ğŸŸ ä»Šã™ãæœ‰æ–™ç™»éŒ²ã™ã‚‹</a>
    </div>
  {% elif current_user.created_at %}
    {% set remaining_days = 5 - (date.today() - current_user.created_at.date()).days %}
    {% if remaining_days > 0 %}
      <div style="padding: 8px; border: 1px solid #ccc; border-radius: 6px; background-color: #fefefe; margin:12px auto 8px; max-width:440px;">
        <p style="font-size: 13px; color: #444; margin:0;">
          â° ç„¡æ–™æœŸé–“ä¸­ã§ã™ï¼ˆã‚ã¨ <strong>{{ remaining_days }}</strong> æ—¥ï¼‰ã€‚<br>
          çµ‚äº†å¾Œã¯éŒ²éŸ³ã‚„åˆ†æãªã©ã«åˆ¶é™ãŒã‹ã‹ã‚Šã¾ã™ã€‚
        </p>
        <a href="{{ url_for('checkout') }}" class="btn btn-info" style="margin-top:6px;">ğŸŸ æœ‰æ–™ãƒ—ãƒ©ãƒ³ã®è©³ç´°ã‚’è¦‹ã‚‹</a>
      </div>
    {% else %}
      <div style="padding: 8px; border: 1px solid #faa; border-radius: 6px; background-color: #fff0f0; margin:12px auto 8px; max-width:440px;">
        <p style="font-size: 13px; color: #a00; margin:0;">
          âš ï¸ ç„¡æ–™æœŸé–“ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚éŒ²éŸ³ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚<br>
          ç¶šã‘ã¦ä½¿ã†ã«ã¯æœ‰æ–™ç™»éŒ²ï¼ˆæœˆé¡300å††ï¼‰ãŒå¿…è¦ã§ã™ã€‚
        </p>
        <a href="{{ url_for('checkout') }}" class="btn btn-warning" style="margin-top:6px;">ğŸŸ ä»Šã™ãæœ‰æ–™ç™»éŒ²ã™ã‚‹</a>
      </div>
    {% endif %}
  {% endif %}
{% endif %}
    <a href="/dashboard" class="button">ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>

    <script>
      // 1) ã‚µãƒ¼ãƒã‹ã‚‰æ¥ãŸã€Œå…¨ä»¶ã€
      const ALL_DATES  = {{ dates|tojson|safe }};     // 'YYYY-MM-DD' ãŒç†æƒ³ã ãŒã€'YYYY/MM/DD' ã§ã‚‚å¯
      const ALL_SCORES = {{ scores|tojson|safe }};
      const BASELINE   = {{ baseline|tojson|safe }};

      // 2) æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæºã‚Œã«å¼·ã„ï¼‰
      function parseDateSmart(x){
        if (x instanceof Date) return x;
        if (typeof x !== 'string') return new Date(x);
        // 2025-08-31 / 2025/08/31
        let m = x.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
        if (m) return new Date(+m[1], +m[2]-1, +m[3]);
        // 08/31 â†’ ä»Šå¹´æ‰±ã„
        m = x.match(/^(\d{1,2})\/(\d{1,2})$/);
        if (m) { const Y = new Date().getFullYear(); return new Date(Y, +m[1]-1, +m[2]); }
        // ISOãªã©ãã®ä»–
        return new Date(x);
      }
      function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
      function endOfDay(d){   return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }

      // 3) ãƒ¬ãƒ³ã‚¸è¨ˆç®—ï¼ˆä»Šæ—¥åŸºæº–ï¼‰
      function getRange(kind){
        const today = new Date();
        if (kind === 'past'){ // å…ˆæœˆ
          const first = new Date(today.getFullYear(), today.getMonth()-1, 1);
          const last  = new Date(today.getFullYear(), today.getMonth(), 0);
          return [startOfDay(first), endOfDay(last)];
        }
        if (kind === 'month'){ // ä»Šæœˆ
          const first = new Date(today.getFullYear(), today.getMonth(), 1);
          return [startOfDay(first), endOfDay(today)];
        }
        if (kind === 'week'){ // ç›´è¿‘7æ—¥ï¼ˆä»Šæ—¥å«ã‚€ï¼‰
          const start = new Date(today);
          start.setDate(start.getDate()-6);
          return [startOfDay(start), endOfDay(today)];
        }
        return [null, null];  // all
      }

      // 4) ã‚¯ã‚¨ãƒªå–å¾— â†’ ãƒ•ã‚£ãƒ«ã‚¿
      const qs    = new URLSearchParams(location.search);
      const range = qs.get('range') || 'all';   // 'all' | 'past' | 'month' | 'week'
      const [from, to] = getRange(range);

      let dates = [], scores = [];
      if (from && to){
        for (let i=0;i<ALL_DATES.length;i++){
          const d = parseDateSmart(ALL_DATES[i]);
          if (d >= from && d <= to){
            dates.push(ALL_DATES[i]);
            scores.push(ALL_SCORES[i]);
          }
        }
      } else {
        dates = ALL_DATES.slice();
        scores = ALL_SCORES.slice();
      }

      // 5) Chart.js ã‚’ã€Œçµã£ãŸé…åˆ—ã€ã§ç”Ÿæˆï¼ˆâ˜…ã“ã“ãŒé‡è¦ï¼‰
      const ctx = document.getElementById('stressChart').getContext('2d');
      const stressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢',
              data: scores,
              fill: false,
              borderColor: 'rgba(75, 192, 192, 1)',
              tension: 0.2,
              pointRadius: 5,
              pointHoverRadius: 8
            },
            {
              label: 'ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆ5æ—¥å¹³å‡ï¼‰',
              data: Array(dates.length).fill(BASELINE), // â† labels ã¨åŒã˜é•·ã•
              fill: false,
              borderColor: 'rgba(255, 99, 132, 0.8)',
              borderDash: [5, 5],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: { min: 0, max: 100, title: { display: true, text: 'ã‚¹ã‚³ã‚¢ï¼ˆ0ã€œ100ï¼‰' } },
            x: { ticks: { autoSkip: true, maxTicksLimit: 7 } }
          },
          plugins: { tooltip: { enabled: true, mode: 'nearest', intersect: true } },
          onClick: (evt, active) => {
            if (active.length) {
              stressChart.setActiveElements(active);
              stressChart.tooltip.setActiveElements(active, { x: evt.x, y: evt.y });
              stressChart.update();
            }
          }
        }
      });

      // 6) ä»Šã®ãƒ¬ãƒ³ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’å¼·èª¿ï¼ˆä»»æ„ï¼‰
      document.querySelectorAll('a[href*="range="]').forEach(a=>{
        const k = new URL(a.href).searchParams.get('range') || 'all';
        if (k === range) a.style.fontWeight = '700';
      });
    </script>
    
    <footer style="margin-top: 40px; padding: 20px; border-top: 2px solid #ccc; background-color: #f9f9f9;">
    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
      <p style="font-size: 14px;">
        <a href="/terms">åˆ©ç”¨è¦ç´„</a> |
        <a href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> |
        {% if not FREE_MODE %}
          <a href="/legal">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a> |
        {% endif %}
        <a href="{{ url_for('contact') }}">ãŠå•ã„åˆã‚ã›</a>
      </p>
    </div>
  </footer>
</body>
</html>
